---
- name: get build image, git clone repo, get deps, build artifact
  hosts: web
  become: yes
  tasks:

  - name: Install needed packages on builder machine maven and git
    apt: pkg={{ item }}
    with_items: 
      - git
      - maven
    update_cache: yes

  - name: Ensure git is present
    apt:
      name: git
      state: present
    
  - name: Ensure maven is present
    apt:
      name: maven
      state: present
    
  - name: git clone target repo
     git:
      repo: https://github.com/shooxep0daemon/ansible1.git
      dest: /home/buildhere/

  - name: Ensure artifact is built from source
    shell: "cd /home/buildhere && mvn package"
    register: "mvn_result"

  - name: fetch built artifact to host
    fetch: src=/home/buildhere/target/hello-world-1.0-SNAPSHOT.jar dest=/tmp/arifact/hello-world-1.0-SNAPSHOT.jar

- name: Run built artefact
  hosts: web
  become: yes
  tasks:
  - name: copy built artifact to remote
    copy: src=/tmp/artifact/hello-world-1.0-SNAPSHOT.jar dest=/runme/hello-world-1.0-SNAPSHOT.jar
  
  - name: ensure jar file is present
    

  - name: run built artifact
    shell: java -jar /runme/hello-world-1.0-SNAPSHOT.jar